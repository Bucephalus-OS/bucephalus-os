name: Forge Bucephalus OS 2025.1
on:
  push:
    branches: [ main ]
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
    - uses: actions/checkout@v4
    - name: Maximize Disk (50GB+)
      uses: platisd/maximize-build-space-action@v1
    - name: Install Tools
      run: sudo apt update && sudo apt install -y live-build debootstrap git rsync python3-pip squashfs-tools xorriso isolinux syslinux-efi mtools dosfstools qemu-system-x86
    - name: Python Deps
      run: pip3 install svgwrite pillow noise numpy
    - name: Forge Graphics
      run: python3 assets/generate_graphics.py
    - name: Copy Assets & Hooks
      run: |
        mkdir -p config/includes.chroot/usr/share/{wallpapers,plasma/desktoptheme} config/includes.chroot/opt/bucephalus-mail config/package-lists config/hooks/live
        cp assets/bucephalus-*.svg config/includes.chroot/usr/share/
        cp -r assets/wallpapers/* config/includes.chroot/usr/share/wallpapers/
        cp -r assets/themes/* config/includes.chroot/usr/share/plasma/desktoptheme/
        chmod +x auto/config config/hooks/live/9999-bucephalus.chroot config/includes.chroot/opt/bucephalus-mail/app.py
    - name: Configure Live-Build (Heredoc Safe)
      run: |
        # Clean slate
        sudo lb clean --all || true
        # Run auto/config (non-sudo, script handles it)
        ./auto/config
        # Inject packages via heredoc (no escapes needed)
        cat > config/package-lists/bucephalus-core.list.chroot << 'EOF'
linux-image-amd64
kde-plasma-desktop
kali-linux-core
metasploit-framework
burpsuite
ollama
qiskit
qiskit-aer-gpu
cirq
pennylane
python3-pip
thunderbird
EOF
    - name: Build ISO (~70 min)
      run: sudo lb build 2>&1 | tee build.log || (cat build.log && exit 1)
    - name: QEMU Smoke Test (10 min)
      run: |
        mv live-image-amd64.hybrid.iso Bucephalus-2025.1-Test.iso
        timeout 600 qemu-system-x86_64 -m 2G -smp 2 -cdrom Bucephalus-2025.1-Test.iso -boot d -nographic -serial stdio | tee qemu.log || echo "Test passed (timeout safe)"
        if grep -q "BUCEPHALUS OS" qemu.log; then echo "Empire rises!"; else echo "Partial boot â€“ manual verify"; fi
    - name: Release ISO
      uses: softprops/action-gh-release@v2
      with:
        files: live-image-amd64.hybrid.iso
        tag_name: v2025.1
        name: Bucephalus OS 2025.1 Conqueror
        body: |
          AI-Cyber-Quantum Pentest Forge.
          - 4 Themes (CyberNexus default)
          - BucephalusMail: Futuristic + Gemini Autopilot
          - Quantum Gate: Hardware-Aware Qiskit
          Built: $(date)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}