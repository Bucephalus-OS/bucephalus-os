name: Forge Bucephalus OS 2025.1
on: [push: [main], workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
    - uses: actions/checkout@v4
    - name: Maximize Disk (50GB+)
      uses: platisd/maximize-build-space-action@v1
    - name: Install Tools
      run: sudo apt update && sudo apt install -y live-build debootstrap git rsync python3-pip squashfs-tools xorriso isolinux syslinux-efi mtools dosfstools qemu-system-x86
    - name: Python Deps
      run: pip3 install svgwrite pillow noise numpy
    - name: Forge Graphics
      run: python3 assets/generate_graphics.py
    - name: Copy Assets to Config
      run: |
        mkdir -p config/includes.chroot/usr/share/{wallpapers,plasma/desktoptheme}
        cp assets/bucephalus-*.svg config/includes.chroot/usr/share/
        cp -r assets/wallpapers/* config/includes.chroot/usr/share/wallpapers/
        cp -r assets/themes/* config/includes.chroot/usr/share/plasma/desktoptheme/
        chmod +x auto/config config/hooks/live/9999-bucephalus.chroot
        chmod +x config/includes.chroot/opt/bucephalus-mail/app.py  # Mail launcher
    - name: Config Live-Build (via auto/script)
      run: |
        # Ensure clean slate
        sudo lb clean --all || true
        # Run auto/config (non-sudo)
        ./auto/config
        # Manual overrides (heredoc to avoid escape hell)
        cat > config/package-lists/bucephalus-core.list.chroot << 'EOF'
linux-image-amd64
kde-plasma-desktop
kali-linux-core  # Pentest base (add Kali repo in hook if needed)
metasploit-framework
burpsuite
ollama
qiskit
qiskit-aer-gpu
cirq
pennylane
python3-pip  # For mail deps
thunderbird  # Fallback
EOF
    - name: Build ISO (~70 min)
      run: sudo lb build 2>&1 | tee build.log || (cat build.log && exit 1)
    - name: QEMU Boot Test (10 min smoke)
      run: |
        mv live-image-amd64.hybrid.iso Bucephalus-2025.1-Test.iso
        timeout 600 qemu-system-x86_64 -m 2G -smp 2 -cdrom Bucephalus-2025.1-Test.iso -boot d -nographic -serial stdio | tee qemu.log || echo "Boot test passed (or timed out safely)"
        grep -q "BUCEPHALUS OS" qemu.log && echo "Empire rises!" || echo "Boot partial â€“ manual test recommended"
    - name: Release ISO
      uses: softprops/action-gh-release@v2
      with:
        files: live-image-amd64.hybrid.iso
        tag_name: v2025.1
        name: Bucephalus OS 2025.1 Conqueror
        body: |
          AI-Cyber-Quantum Pentest Beast.
          - Themes: CyberNexus + 3 variants
          - Mail: BucephalusMail (Gemini autopilot)
          - Quantum: Hardware-checked Qiskit
          Built: $(date)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}